"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.dasmTypeScript = void 0;
const codemaker_1 = require("codemaker");
const fs = require("fs");
const os = require("os");
const path = require("path");
const util_1 = require("util");
const mkdtemp = (0, util_1.promisify)(fs.mkdtemp);
const readFile = (0, util_1.promisify)(fs.readFile);
async function dasmTypeScript(template, options = {}) {
    const definitions = new Array();
    for (const [id, resource] of Object.entries(template.Resources || {})) {
        const type = resource.Type;
        const props = resource.Properties || {};
        definitions.push({
            id,
            ...toCfnClassName(type),
            props: capitalizeKeys(props)
        });
    }
    const code = new codemaker_1.CodeMaker();
    const outFile = 'out.ts';
    code.openFile(outFile);
    const timestamp = options.timestamp !== undefined ? options.timestamp : true;
    const suffix = timestamp ? `at ${new Date().toISOString()}` : '';
    code.line(`// generated by cdk-dasm ${suffix}`);
    code.line();
    //
    // imports
    //
    code.line(`import { Stack, StackProps, Fn } from '@aws-cdk/core';`);
    code.line(`import { Construct } from 'constructs';`);
    for (const ns of getUniqueNamespaces(definitions)) {
        const importName = `@aws-cdk/aws-${ns}`;
        code.line(`import ${ns} = require('${importName}');`);
    }
    code.line();
    //
    // stack
    //
    code.openBlock(`export class MyStack extends Stack`);
    code.openBlock(`constructor(scope: Construct, id: string, props: StackProps = {})`);
    code.line(`super(scope, id, props);`);
    for (const def of definitions) {
        // no props
        if (Object.keys(def.props).length === 0) {
            code.line(`new ${def.className}(this, '${def.id}');`);
            continue;
        }
        code.indent(`new ${def.className}(this, '${def.id}', {`);
        for (const [key, value] of Object.entries(def.props)) {
            const json = JSON.stringify(value, undefined, 2);
            const [first, ...rest] = json.split('\n');
            if (rest.length === 0) {
                code.line(`${key}: ${first},`); // single line
            }
            else {
                code.line(`${key}: ${first}`);
                rest.forEach((r, i) => {
                    code.line(r + ((i === rest.length - 1) ? ',' : ''));
                });
            }
        }
        code.unindent('});');
    }
    code.closeBlock();
    code.closeBlock(' // MyStack');
    code.closeFile(outFile);
    const workdir = await mkdtemp(path.join(os.tmpdir(), 'cdk-dasm-typescript'));
    await code.save(workdir);
    return (await readFile(path.join(workdir, outFile))).toString();
}
exports.dasmTypeScript = dasmTypeScript;
function capitalizeKeys(x) {
    if (typeof (x) === 'function') {
        throw new Error(`function?`);
    }
    if (Array.isArray(x)) {
        return x.map(i => capitalizeKeys(i));
    }
    if (typeof (x) === 'object') {
        const ret = {};
        for (const [key, value] of Object.entries(x)) {
            let newKey;
            if (key === 'Ref' || key.startsWith('Fn::')) {
                newKey = key;
            }
            else {
                newKey = (0, codemaker_1.toCamelCase)(key);
            }
            ret[newKey] = capitalizeKeys(value);
        }
        return ret;
    }
    // primitive
    return x;
}
function toCfnClassName(resourceType) {
    const [, namespace, type] = resourceType.split('::');
    const className = `${namespace.toLocaleLowerCase()}.Cfn${type}`;
    return { namespace: namespace.toLocaleLowerCase(), className };
}
function getUniqueNamespaces(definitions) {
    return [...new Set(definitions.map(definition => definition.namespace))];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRhc20udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEseUNBQW1EO0FBQ25ELHlCQUF5QjtBQUN6Qix5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLCtCQUFpQztBQUVqQyxNQUFNLE9BQU8sR0FBRyxJQUFBLGdCQUFTLEVBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3RDLE1BQU0sUUFBUSxHQUFHLElBQUEsZ0JBQVMsRUFBQyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7QUFrQmpDLEtBQUssVUFBVSxjQUFjLENBQUMsUUFBa0IsRUFBRSxVQUErQixFQUFFO0lBQ3hGLE1BQU0sV0FBVyxHQUFHLElBQUksS0FBSyxFQUF1QixDQUFDO0lBRXJELEtBQUssTUFBTSxDQUFFLEVBQUUsRUFBRSxRQUFRLENBQUUsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDLEVBQUU7UUFDdkUsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztRQUMzQixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQztRQUV4QyxXQUFXLENBQUMsSUFBSSxDQUFDO1lBQ2YsRUFBRTtZQUNGLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQztZQUN2QixLQUFLLEVBQUUsY0FBYyxDQUFDLEtBQUssQ0FBQztTQUM3QixDQUFDLENBQUM7S0FDSjtJQUVELE1BQU0sSUFBSSxHQUFHLElBQUkscUJBQVMsRUFBRSxDQUFDO0lBRTdCLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQztJQUV6QixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXZCLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxTQUFTLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENB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O1FBQ0QsT0FBTyxHQUFHLENBQUM7S0FDWjtJQUVELFlBQVk7SUFDWixPQUFPLENBQUMsQ0FBQztBQUNYLENBQUM7QUFFRCxTQUFTLGNBQWMsQ0FBQyxZQUFvQjtJQUMxQyxNQUFNLENBQUUsQUFBRCxFQUFHLFNBQVMsRUFBRSxJQUFJLENBQUUsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZELE1BQU0sU0FBUyxHQUFHLEdBQUcsU0FBUyxDQUFDLGlCQUFpQixFQUFFLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFDaEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxTQUFTLEVBQUUsQ0FBQztBQUNqRSxDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxXQUF1QztJQUNsRSxPQUFPLENBQUMsR0FBSSxJQUFJLEdBQUcsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM1RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29kZU1ha2VyLCB0b0NhbWVsQ2FzZSB9IGZyb20gJ2NvZGVtYWtlcic7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcHJvbWlzaWZ5IH0gZnJvbSAndXRpbCc7XG5cbmNvbnN0IG1rZHRlbXAgPSBwcm9taXNpZnkoZnMubWtkdGVtcCk7XG5jb25zdCByZWFkRmlsZSA9IHByb21pc2lmeShmcy5yZWFkRmlsZSk7XG5cbmludGVyZmFjZSBDb25zdHJ1Y3REZWZpbml0aW9uIHtcbiAgbmFtZXNwYWNlOiBzdHJpbmc7XG4gIGNsYXNzTmFtZTogc3RyaW5nO1xuICBpZDogc3RyaW5nO1xuICBwcm9wczogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEaXNhc3NlbWJsZXJPcHRpb25zIHtcbiAgLyoqXG4gICAqIEluY2x1ZGUgYSB0aW1lc3RhbXAgaW4gdGhlIGdlbmVyYXRlZCBvdXRwdXQuXG4gICAqXG4gICAqIEBkZWZhdWx0IHRydWVcbiAgICovXG4gIHJlYWRvbmx5IHRpbWVzdGFtcD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkYXNtVHlwZVNjcmlwdCh0ZW1wbGF0ZTogVGVtcGxhdGUsIG9wdGlvbnM6IERpc2Fzc2VtYmxlck9wdGlvbnMgPSB7fSkge1xuICBjb25zdCBkZWZpbml0aW9ucyA9IG5ldyBBcnJheTxDb25zdHJ1Y3REZWZpbml0aW9uPigpO1xuXG4gIGZvciAoY29uc3QgWyBpZCwgcmVzb3VyY2UgXSBvZiBPYmplY3QuZW50cmllcyh0ZW1wbGF0ZS5SZXNvdXJjZXMgfHwge30pKSB7XG4gICAgY29uc3QgdHlwZSA9IHJlc291cmNlLlR5cGU7XG4gICAgY29uc3QgcHJvcHMgPSByZXNvdXJjZS5Qcm9wZXJ0aWVzIHx8IHt9O1xuXG4gICAgZGVmaW5pdGlvbnMucHVzaCh7XG4gICAgICBpZCxcbiAgICAgIC4uLnRvQ2ZuQ2xhc3NOYW1lKHR5cGUpLFxuICAgICAgcHJvcHM6IGNhcGl0YWxpemVLZXlzKHByb3BzKVxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgY29kZSA9IG5ldyBDb2RlTWFrZXIoKTtcblxuICBjb25zdCBvdXRGaWxlID0gJ291dC50cyc7XG5cbiAgY29kZS5vcGVuRmlsZShvdXRGaWxlKTtcblxuICBjb25zdCB0aW1lc3RhbXAgPSBvcHRpb25zLnRpbWVzdGFtcCAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy50aW1lc3RhbXAgOiB0cnVlO1xuICBjb25zdCBzdWZmaXggPSB0aW1lc3RhbXAgPyAgYGF0ICR7bmV3IERhdGUoKS50b0lTT1N0cmluZygpfWAgOiAnJztcblxuICBjb2RlLmxpbmUoYC8vIGdlbmVyYXRlZCBieSBjZGstZGFzbSAke3N1ZmZpeH1gKTtcbiAgY29kZS5saW5lKCk7XG5cbiAgLy9cbiAgLy8gaW1wb3J0c1xuICAvL1xuXG4gIGNvZGUubGluZShgaW1wb3J0IHsgU3RhY2ssIFN0YWNrUHJvcHMsIEZuIH0gZnJvbSAnQGF3cy1jZGsvY29yZSc7YCk7XG4gIGNvZGUubGluZShgaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7YCk7XG5cbiAgZm9yIChjb25zdCBucyBvZiBnZXRVbmlxdWVOYW1lc3BhY2VzKGRlZmluaXRpb25zKSkge1xuICAgIGNvbnN0IGltcG9ydE5hbWUgPSBgQGF3cy1jZGsvYXdzLSR7bnN9YDtcbiAgICBjb2RlLmxpbmUoYGltcG9ydCAke25zfSA9IHJlcXVpcmUoJyR7aW1wb3J0TmFtZX0nKTtgKTtcbiAgfVxuXG4gIGNvZGUubGluZSgpO1xuXG4gIC8vXG4gIC8vIHN0YWNrXG4gIC8vXG5cbiAgY29kZS5vcGVuQmxvY2soYGV4cG9ydCBjbGFzcyBNeVN0YWNrIGV4dGVuZHMgU3RhY2tgKTtcbiAgY29kZS5vcGVuQmxvY2soYGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBTdGFja1Byb3BzID0ge30pYCk7XG4gIGNvZGUubGluZShgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7YCk7XG5cbiAgZm9yIChjb25zdCBkZWYgb2YgZGVmaW5pdGlvbnMpIHtcblxuICAgIC8vIG5vIHByb3BzXG4gICAgaWYgKE9iamVjdC5rZXlzKGRlZi5wcm9wcykubGVuZ3RoID09PSAwKSB7XG4gICAgICBjb2RlLmxpbmUoYG5ldyAke2RlZi5jbGFzc05hbWV9KHRoaXMsICcke2RlZi5pZH0nKTtgKTtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGNvZGUuaW5kZW50KGBuZXcgJHtkZWYuY2xhc3NOYW1lfSh0aGlzLCAnJHtkZWYuaWR9Jywge2ApO1xuXG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoZGVmLnByb3BzKSkge1xuICAgICAgY29uc3QganNvbiA9IEpTT04uc3RyaW5naWZ5KHZhbHVlLCB1bmRlZmluZWQsIDIpO1xuICAgICAgY29uc3QgWyBmaXJzdCwgLi4ucmVzdCBdID0ganNvbi5zcGxpdCgnXFxuJyk7XG5cbiAgICAgIGlmIChyZXN0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBjb2RlLmxpbmUoYCR7a2V5fTogJHtmaXJzdH0sYCk7IC8vIHNpbmdsZSBsaW5lXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb2RlLmxpbmUoYCR7a2V5fTogJHtmaXJzdH1gKTtcbiAgICAgICAgcmVzdC5mb3JFYWNoKChyLCBpKSA9PiB7XG4gICAgICAgICAgY29kZS5saW5lKHIgKyAoKGkgPT09IHJlc3QubGVuZ3RoIC0gMSkgPyAnLCcgOiAnJykpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb2RlLnVuaW5kZW50KCd9KTsnKTtcbiAgfVxuXG4gIGNvZGUuY2xvc2VCbG9jaygpO1xuXG4gIGNvZGUuY2xvc2VCbG9jaygnIC8vIE15U3RhY2snKTtcblxuICBjb2RlLmNsb3NlRmlsZShvdXRGaWxlKTtcblxuICBjb25zdCB3b3JrZGlyID0gYXdhaXQgbWtkdGVtcChwYXRoLmpvaW4ob3MudG1wZGlyKCksICdjZGstZGFzbS10eXBlc2NyaXB0JykpO1xuICBhd2FpdCBjb2RlLnNhdmUod29ya2Rpcik7XG5cbiAgcmV0dXJuIChhd2FpdCByZWFkRmlsZShwYXRoLmpvaW4od29ya2Rpciwgb3V0RmlsZSkpKS50b1N0cmluZygpO1xufVxuXG5mdW5jdGlvbiBjYXBpdGFsaXplS2V5cyh4OiBhbnkpOiBhbnkge1xuICBpZiAodHlwZW9mKHgpID09PSAnZnVuY3Rpb24nKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBmdW5jdGlvbj9gKTtcbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KHgpKSB7XG4gICAgcmV0dXJuIHgubWFwKGkgPT4gY2FwaXRhbGl6ZUtleXMoaSkpO1xuICB9XG5cbiAgaWYgKHR5cGVvZih4KSA9PT0gJ29iamVjdCcpIHtcbiAgICBjb25zdCByZXQ6IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fTtcbiAgICBmb3IgKGNvbnN0IFsga2V5LCB2YWx1ZSBdIG9mIE9iamVjdC5lbnRyaWVzKHgpKSB7XG4gICAgICBsZXQgbmV3S2V5O1xuICAgICAgaWYgKGtleSA9PT0gJ1JlZicgfHwga2V5LnN0YXJ0c1dpdGgoJ0ZuOjonKSkge1xuICAgICAgICBuZXdLZXkgPSBrZXk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXdLZXkgPSB0b0NhbWVsQ2FzZShrZXkpO1xuICAgICAgfVxuXG4gICAgICByZXRbbmV3S2V5XSA9IGNhcGl0YWxpemVLZXlzKHZhbHVlKTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbiAgfVxuXG4gIC8vIHByaW1pdGl2ZVxuICByZXR1cm4geDtcbn1cblxuZnVuY3Rpb24gdG9DZm5DbGFzc05hbWUocmVzb3VyY2VUeXBlOiBzdHJpbmcpIHtcbiAgY29uc3QgWyAsIG5hbWVzcGFjZSwgdHlwZSBdID0gcmVzb3VyY2VUeXBlLnNwbGl0KCc6OicpO1xuICBjb25zdCBjbGFzc05hbWUgPSBgJHtuYW1lc3BhY2UudG9Mb2NhbGVMb3dlckNhc2UoKX0uQ2ZuJHt0eXBlfWA7XG4gIHJldHVybiB7IG5hbWVzcGFjZTogbmFtZXNwYWNlLnRvTG9jYWxlTG93ZXJDYXNlKCksIGNsYXNzTmFtZSB9O1xufVxuXG5mdW5jdGlvbiBnZXRVbmlxdWVOYW1lc3BhY2VzKGRlZmluaXRpb25zOiBBcnJheTxDb25zdHJ1Y3REZWZpbml0aW9uPik6IFN0cmluZ1tdIHtcbiAgcmV0dXJuIFsuLi4gbmV3IFNldChkZWZpbml0aW9ucy5tYXAoZGVmaW5pdGlvbiA9PiBkZWZpbml0aW9uLm5hbWVzcGFjZSkpXTtcbn1cblxuaW50ZXJmYWNlIFRlbXBsYXRlIHtcbiAgUmVzb3VyY2VzOiB7IFtpZDogc3RyaW5nXTogUmVzb3VyY2UgfTtcbn1cblxuaW50ZXJmYWNlIFJlc291cmNlIHtcbiAgVHlwZTogc3RyaW5nO1xuICBQcm9wZXJ0aWVzPzogeyBbcHJvcDogc3RyaW5nXTogYW55IH1cbn1cbiJdfQ==