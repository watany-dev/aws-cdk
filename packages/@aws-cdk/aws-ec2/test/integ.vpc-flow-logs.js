"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_iam_1 = require("@aws-cdk/aws-iam");
const s3 = require("@aws-cdk/aws-s3");
const core_1 = require("@aws-cdk/core");
const integ_tests_1 = require("@aws-cdk/integ-tests");
const lib_1 = require("../lib");
const app = new core_1.App();
class FeatureFlagStack extends core_1.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const vpc = new lib_1.Vpc(this, 'VPC', { natGateways: 1 });
        const flowLog = vpc.addFlowLog('FlowLogsS3', {
            destination: lib_1.FlowLogDestination.toS3(),
        });
        this.bucket = flowLog.bucket;
        this.bucketArn = this.exportValue(flowLog.bucket.bucketArn);
        vpc.addFlowLog('FlowLogsS3WithDestinationOptions', {
            destination: lib_1.FlowLogDestination.toS3(undefined, undefined, {
                hiveCompatiblePartitions: true,
            }),
        });
        new lib_1.Instance(this, 'FlowLogsInstance', {
            vpc,
            instanceType: lib_1.InstanceType.of(lib_1.InstanceClass.T3, lib_1.InstanceSize.SMALL),
            machineImage: lib_1.MachineImage.latestAmazonLinux({
                generation: lib_1.AmazonLinuxGeneration.AMAZON_LINUX_2,
            }),
        });
    }
}
class DependencyTestStack extends core_1.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const vpc = new lib_1.Vpc(this, 'VPC', { natGateways: 1 });
        const bucket = new s3.Bucket(this, 'Bucket', {
            autoDeleteObjects: true,
            removalPolicy: core_1.RemovalPolicy.DESTROY,
        });
        vpc.addFlowLog('FlowLogS3', {
            destination: lib_1.FlowLogDestination.toS3(bucket, 'vpcFlowLog'),
        });
    }
}
class TestStack extends core_1.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const vpc = new lib_1.Vpc(this, 'VPC', { natGateways: 1 });
        new lib_1.FlowLog(this, 'FlowLogsCW', {
            resourceType: lib_1.FlowLogResourceType.fromVpc(vpc),
        });
        vpc.addFlowLog('FlowLogsS3', {
            destination: lib_1.FlowLogDestination.toS3(),
        });
        const bucket = new s3.Bucket(this, 'Bucket', {
            removalPolicy: core_1.RemovalPolicy.DESTROY,
            autoDeleteObjects: true,
        });
        bucket.addToResourcePolicy(new aws_iam_1.PolicyStatement({
            effect: aws_iam_1.Effect.ALLOW,
            principals: [new aws_iam_1.ServicePrincipal('delivery.logs.amazonaws.com')],
            actions: ['s3:PutObject'],
            resources: [bucket.arnForObjects(`AWSLogs/${this.account}/*`)],
            conditions: {
                StringEquals: {
                    's3:x-amz-acl': 'bucket-owner-full-control',
                    'aws:SourceAccount': this.account,
                },
                ArnLike: {
                    'aws:SourceArn': this.formatArn({
                        service: 'logs',
                        resource: '*',
                    }),
                },
            },
        }));
        bucket.addToResourcePolicy(new aws_iam_1.PolicyStatement({
            effect: aws_iam_1.Effect.ALLOW,
            principals: [new aws_iam_1.ServicePrincipal('delivery.logs.amazonaws.com')],
            actions: ['s3:GetBucketAcl', 's3:ListBucket'],
            resources: [bucket.bucketArn],
            conditions: {
                StringEquals: {
                    'aws:SourceAccount': this.account,
                },
                ArnLike: {
                    'aws:SourceArn': this.formatArn({
                        service: 'logs',
                        resource: '*',
                    }),
                },
            },
        }));
        vpc.addFlowLog('FlowLogsS3KeyPrefix', {
            destination: lib_1.FlowLogDestination.toS3(bucket, 'prefix/'),
        });
    }
}
const featureFlagTest = new FeatureFlagStack(app, 'FlowLogsFeatureFlag');
const integ = new integ_tests_1.IntegTest(app, 'FlowLogs', {
    testCases: [
        new TestStack(app, 'FlowLogsTestStack'),
        featureFlagTest,
        new DependencyTestStack(app, 'DependencyTestStack'),
    ],
});
const objects = integ.assertions.awsApiCall('S3', 'listObjectsV2', {
    Bucket: featureFlagTest.bucket.bucketName,
    MaxKeys: 1,
    Prefix: `AWSLogs/${featureFlagTest.account}/vpcflowlogs`,
});
const assertionProvider = objects.node.tryFindChild('SdkProvider');
assertionProvider.addPolicyStatementFromSdkCall('s3', 'ListBucket', [featureFlagTest.bucketArn]);
assertionProvider.addPolicyStatementFromSdkCall('s3', 'GetObject', [`${featureFlagTest.bucketArn}/*`]);
objects.expect(integ_tests_1.ExpectedResult.objectLike({
    KeyCount: 1,
}));
app.synth();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZWcudnBjLWZsb3ctbG9ncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImludGVnLnZwYy1mbG93LWxvZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4Q0FBNkU7QUFDN0Usc0NBQXNDO0FBQ3RDLHdDQUFzRTtBQUN0RSxzREFBcUY7QUFDckYsZ0NBQXlLO0FBRXpLLE1BQU0sR0FBRyxHQUFHLElBQUksVUFBRyxFQUFFLENBQUM7QUFFdEIsTUFBTSxnQkFBaUIsU0FBUSxZQUFLO0lBR2xDLFlBQVksS0FBVSxFQUFFLEVBQVUsRUFBRSxLQUFrQjtRQUNwRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixNQUFNLEdBQUcsR0FBRyxJQUFJLFNBQUcsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsV0FBVyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFckQsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxZQUFZLEVBQUU7WUFDM0MsV0FBVyxFQUFFLHdCQUFrQixDQUFDLElBQUksRUFBRTtTQUN2QyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFPLENBQUM7UUFDOUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxNQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFN0QsR0FBRyxDQUFDLFVBQVUsQ0FBQyxrQ0FBa0MsRUFBRTtZQUNqRCxXQUFXLEVBQUUsd0JBQWtCLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUU7Z0JBQ3pELHdCQUF3QixFQUFFLElBQUk7YUFDL0IsQ0FBQztTQUNILENBQUMsQ0FBQztRQUVILElBQUksY0FBUSxDQUFDLElBQUksRUFBRSxrQkFBa0IsRUFBRTtZQUNyQyxHQUFHO1lBQ0gsWUFBWSxFQUFFLGtCQUFZLENBQUMsRUFBRSxDQUFD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QUMsSUFBSSxFQUFFLFlBQVksRUFBRSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0FBQ2pHLGlCQUFpQixDQUFDLDZCQUE2QixDQUFDLElBQUksRUFBRSxXQUFXLEVBQUUsQ0FBQyxHQUFHLGVBQWUsQ0FBQyxTQUFTLElBQUksQ0FBQyxDQUFDLENBQUM7QUFFdkcsT0FBTyxDQUFDLE1BQU0sQ0FBQyw0QkFBYyxDQUFDLFVBQVUsQ0FBQztJQUN2QyxRQUFRLEVBQUUsQ0FBQztDQUNaLENBQUMsQ0FBQyxDQUFDO0FBRUosR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUG9saWN5U3RhdGVtZW50LCBFZmZlY3QsIFNlcnZpY2VQcmluY2lwYWwgfSBmcm9tICdAYXdzLWNkay9hd3MtaWFtJztcbmltcG9ydCAqIGFzIHMzIGZyb20gJ0Bhd3MtY2RrL2F3cy1zMyc7XG5pbXBvcnQgeyBBcHAsIFJlbW92YWxQb2xpY3ksIFN0YWNrLCBTdGFja1Byb3BzIH0gZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5pbXBvcnQgeyBJbnRlZ1Rlc3QsIEV4cGVjdGVkUmVzdWx0LCBBc3NlcnRpb25zUHJvdmlkZXIgfSBmcm9tICdAYXdzLWNkay9pbnRlZy10ZXN0cyc7XG5pbXBvcnQgeyBGbG93TG9nLCBGbG93TG9nRGVzdGluYXRpb24sIEZsb3dMb2dSZXNvdXJjZVR5cGUsIFZwYywgSW5zdGFuY2UsIEluc3RhbmNlVHlwZSwgSW5zdGFuY2VDbGFzcywgSW5zdGFuY2VTaXplLCBNYWNoaW5lSW1hZ2UsIEFtYXpvbkxpbnV4R2VuZXJhdGlvbiB9IGZyb20gJy4uL2xpYic7XG5cbmNvbnN0IGFwcCA9IG5ldyBBcHAoKTtcblxuY2xhc3MgRmVhdHVyZUZsYWdTdGFjayBleHRlbmRzIFN0YWNrIHtcbiAgcHVibGljIHJlYWRvbmx5IGJ1Y2tldEFybjogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgYnVja2V0OiBzMy5JQnVja2V0O1xuICBjb25zdHJ1Y3RvcihzY29wZTogQXBwLCBpZDogc3RyaW5nLCBwcm9wcz86IFN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIGNvbnN0IHZwYyA9IG5ldyBWcGModGhpcywgJ1ZQQycsIHsgbmF0R2F0ZXdheXM6IDEgfSk7XG5cbiAgICBjb25zdCBmbG93TG9nID0gdnBjLmFkZEZsb3dMb2coJ0Zsb3dMb2dzUzMnLCB7XG4gICAgICBkZXN0aW5hdGlvbjogRmxvd0xvZ0Rlc3RpbmF0aW9uLnRvUzMoKSxcbiAgICB9KTtcbiAgICB0aGlzLmJ1Y2tldCA9IGZsb3dMb2cuYnVja2V0ITtcbiAgICB0aGlzLmJ1Y2tldEFybiA9IHRoaXMuZXhwb3J0VmFsdWUoZmxvd0xvZy5idWNrZXQhLmJ1Y2tldEFybik7XG5cbiAgICB2cGMuYWRkRmxvd0xvZygnRmxvd0xvZ3NTM1dpdGhEZXN0aW5hdGlvbk9wdGlvbnMnLCB7XG4gICAgICBkZXN0aW5hdGlvbjogRmxvd0xvZ0Rlc3RpbmF0aW9uLnRvUzModW5kZWZpbmVkLCB1bmRlZmluZWQsIHtcbiAgICAgICAgaGl2ZUNvbXBhdGlibGVQYXJ0aXRpb25zOiB0cnVlLFxuICAgICAgfSksXG4gICAgfSk7XG5cbiAgICBuZXcgSW5zdGFuY2UodGhpcywgJ0Zsb3dMb2dzSW5zdGFuY2UnLCB7XG4gICAgICB2cGMsXG4gICAgICBpbnN0YW5jZVR5cGU6IEluc3RhbmNlVHlwZS5vZihJbnN0YW5jZUNsYXNzLlQzLCBJbnN0YW5jZVNpemUuU01BTEwpLFxuICAgICAgbWFjaGluZUltYWdlOiBNYWNoaW5lSW1hZ2UubGF0ZXN0QW1hem9uTGludXgoe1xuICAgICAgICBnZW5lcmF0aW9uOiBBbWF6b25MaW51eEdlbmVyYXRpb24uQU1BWk9OX0xJTlVYXzIsXG4gICAgICB9KSxcbiAgICB9KTtcbiAgfVxufVxuXG5jbGFzcyBEZXBlbmRlbmN5VGVzdFN0YWNrIGV4dGVuZHMgU3RhY2sge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQXBwLCBpZDogc3RyaW5nLCBwcm9wcz86IFN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIGNvbnN0IHZwYyA9IG5ldyBWcGModGhpcywgJ1ZQQycsIHsgbmF0R2F0ZXdheXM6IDEgfSk7XG5cbiAgICBjb25zdCBidWNrZXQgPSBuZXcgczMuQnVja2V0KHRoaXMsICdCdWNrZXQnLCB7XG4gICAgICBhdXRvRGVsZXRlT2JqZWN0czogdHJ1ZSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IFJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIHZwYy5hZGRGbG93TG9nKCdGbG93TG9nUzMnLCB7XG4gICAgICBkZXN0aW5hdGlvbjogRmxvd0xvZ0Rlc3RpbmF0aW9uLnRvUzMoYnVja2V0LCAndnBjRmxvd0xvZycpLFxuICAgIH0pO1xuICB9XG59XG5cbmNsYXNzIFRlc3RTdGFjayBleHRlbmRzIFN0YWNrIHtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IEFwcCwgaWQ6IHN0cmluZywgcHJvcHM/OiBTdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICBjb25zdCB2cGMgPSBuZXcgVnBjKHRoaXMsICdWUEMnLCB7IG5hdEdhdGV3YXlzOiAxIH0pO1xuXG4gICAgbmV3IEZsb3dMb2codGhpcywgJ0Zsb3dMb2dzQ1cnLCB7XG4gICAgICByZXNvdXJjZVR5cGU6IEZsb3dMb2dSZXNvdXJjZVR5cGUuZnJvbVZwYyh2cGMpLFxuICAgIH0pO1xuXG4gICAgdnBjLmFkZEZsb3dMb2coJ0Zsb3dMb2dzUzMnLCB7XG4gICAgICBkZXN0aW5hdGlvbjogRmxvd0xvZ0Rlc3RpbmF0aW9uLnRvUzMoKSxcbiAgICB9KTtcblxuICAgIGNvbnN0IGJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQodGhpcywgJ0J1Y2tldCcsIHtcbiAgICAgIHJlbW92YWxQb2xpY3k6IFJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICAgIGF1dG9EZWxldGVPYmplY3RzOiB0cnVlLFxuICAgIH0pO1xuICAgIGJ1Y2tldC5hZGRUb1Jlc291cmNlUG9saWN5KG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgZWZmZWN0OiBFZmZlY3QuQUxMT1csXG4gICAgICBwcmluY2lwYWxzOiBbbmV3IFNlcnZpY2VQcmluY2lwYWwoJ2RlbGl2ZXJ5LmxvZ3MuYW1hem9uYXdzLmNvbScpXSxcbiAgICAgIGFjdGlvbnM6IFsnczM6UHV0T2JqZWN0J10sXG4gICAgICByZXNvdXJjZXM6IFtidWNrZXQuYXJuRm9yT2JqZWN0cyhgQVdTTG9ncy8ke3RoaXMuYWNjb3VudH0vKmApXSxcbiAgICAgIGNvbmRpdGlvbnM6IHtcbiAgICAgICAgU3RyaW5nRXF1YWxzOiB7XG4gICAgICAgICAgJ3MzOngtYW16LWFjbCc6ICdidWNrZXQtb3duZXItZnVsbC1jb250cm9sJyxcbiAgICAgICAgICAnYXdzOlNvdXJjZUFjY291bnQnOiB0aGlzLmFjY291bnQsXG4gICAgICAgIH0sXG4gICAgICAgIEFybkxpa2U6IHtcbiAgICAgICAgICAnYXdzOlNvdXJjZUFybic6IHRoaXMuZm9ybWF0QXJuKHtcbiAgICAgICAgICAgIHNlcnZpY2U6ICdsb2dzJyxcbiAgICAgICAgICAgIHJlc291cmNlOiAnKicsXG4gICAgICAgICAgfSksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pKTtcbiAgICBidWNrZXQuYWRkVG9SZXNvdXJjZVBvbGljeShuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgcHJpbmNpcGFsczogW25ldyBTZXJ2aWNlUHJpbmNpcGFsKCdkZWxpdmVyeS5sb2dzLmFtYXpvbmF3cy5jb20nKV0sXG4gICAgICBhY3Rpb25zOiBbJ3MzOkdldEJ1Y2tldEFjbCcsICdzMzpMaXN0QnVja2V0J10sXG4gICAgICByZXNvdXJjZXM6IFtidWNrZXQuYnVja2V0QXJuXSxcbiAgICAgIGNvbmRpdGlvbnM6IHtcbiAgICAgICAgU3RyaW5nRXF1YWxzOiB7XG4gICAgICAgICAgJ2F3czpTb3VyY2VBY2NvdW50JzogdGhpcy5hY2NvdW50LFxuICAgICAgICB9LFxuICAgICAgICBBcm5MaWtlOiB7XG4gICAgICAgICAgJ2F3czpTb3VyY2VBcm4nOiB0aGlzLmZvcm1hdEFybih7XG4gICAgICAgICAgICBzZXJ2aWNlOiAnbG9ncycsXG4gICAgICAgICAgICByZXNvdXJjZTogJyonLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KSk7XG5cbiAgICB2cGMuYWRkRmxvd0xvZygnRmxvd0xvZ3NTM0tleVByZWZpeCcsIHtcbiAgICAgIGRlc3RpbmF0aW9uOiBGbG93TG9nRGVzdGluYXRpb24udG9TMyhidWNrZXQsICdwcmVmaXgvJyksXG4gICAgfSk7XG4gIH1cbn1cblxuY29uc3QgZmVhdHVyZUZsYWdUZXN0ID0gbmV3IEZlYXR1cmVGbGFnU3RhY2soYXBwLCAnRmxvd0xvZ3NGZWF0dXJlRmxhZycpO1xuXG5jb25zdCBpbnRlZyA9IG5ldyBJbnRlZ1Rlc3QoYXBwLCAnRmxvd0xvZ3MnLCB7XG4gIHRlc3RDYXNlczogW1xuICAgIG5ldyBUZXN0U3RhY2soYXBwLCAnRmxvd0xvZ3NUZXN0U3RhY2snKSxcbiAgICBmZWF0dXJlRmxhZ1Rlc3QsXG4gICAgbmV3IERlcGVuZGVuY3lUZXN0U3RhY2soYXBwLCAnRGVwZW5kZW5jeVRlc3RTdGFjaycpLFxuICBdLFxufSk7XG5cbmNvbnN0IG9iamVjdHMgPSBpbnRlZy5hc3NlcnRpb25zLmF3c0FwaUNhbGwoJ1MzJywgJ2xpc3RPYmplY3RzVjInLCB7XG4gIEJ1Y2tldDogZmVhdHVyZUZsYWdUZXN0LmJ1Y2tldC5idWNrZXROYW1lLFxuICBNYXhLZXlzOiAxLFxuICBQcmVmaXg6IGBBV1NMb2dzLyR7ZmVhdHVyZUZsYWdUZXN0LmFjY291bnR9L3ZwY2Zsb3dsb2dzYCxcbn0pO1xuY29uc3QgYXNzZXJ0aW9uUHJvdmlkZXIgPSBvYmplY3RzLm5vZGUudHJ5RmluZENoaWxkKCdTZGtQcm92aWRlcicpIGFzIEFzc2VydGlvbnNQcm92aWRlcjtcbmFzc2VydGlvblByb3ZpZGVyLmFkZFBvbGljeVN0YXRlbWVudEZyb21TZGtDYWxsKCdzMycsICdMaXN0QnVja2V0JywgW2ZlYXR1cmVGbGFnVGVzdC5idWNrZXRBcm5dKTtcbmFzc2VydGlvblByb3ZpZGVyLmFkZFBvbGljeVN0YXRlbWVudEZyb21TZGtDYWxsKCdzMycsICdHZXRPYmplY3QnLCBbYCR7ZmVhdHVyZUZsYWdUZXN0LmJ1Y2tldEFybn0vKmBdKTtcblxub2JqZWN0cy5leHBlY3QoRXhwZWN0ZWRSZXN1bHQub2JqZWN0TGlrZSh7XG4gIEtleUNvdW50OiAxLFxufSkpO1xuXG5hcHAuc3ludGgoKTtcbiJdfQ==